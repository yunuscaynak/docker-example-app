<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mongo Form Uygulamasi </title>
    <style>
      :root {
        --bg: #f4f6f8;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #0f766e;
        --primary-hover: #115e59;
        --danger: #b91c1c;
        --success: #166534;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        background: radial-gradient(circle at 30% 20%, #dff7f3, var(--bg));
        color: var(--text);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 24px;
      }

      .card {
        width: min(760px, 100%);
        background: var(--card);
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 16px 40px rgba(17, 24, 39, 0.1);
      }

      h1 {
        margin: 0 0 8px;
        font-size: 1.4rem;
      }

      p {
        margin: 0 0 20px;
        color: var(--muted);
      }

      form {
        display: grid;
        gap: 14px;
      }

      label {
        font-size: 0.92rem;
        font-weight: 600;
        display: grid;
        gap: 8px;
      }

      input,
      textarea,
      button {
        font: inherit;
      }

      input,
      textarea {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 10px 12px;
        outline: none;
      }

      input:focus,
      textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.16);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      button {
        border: 0;
        border-radius: 10px;
        padding: 10px 16px;
        background: var(--primary);
        color: #fff;
        cursor: pointer;
        font-weight: 600;
      }

      button:hover {
        background: var(--primary-hover);
      }

      .status {
        min-height: 22px;
        margin-top: 14px;
        font-weight: 600;
      }

      .status.error {
        color: var(--danger);
      }

      .status.success {
        color: var(--success);
      }

      .forms {
        margin-top: 22px;
        border-top: 1px solid #e5e7eb;
        padding-top: 18px;
      }

      .forms-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .forms-header h2 {
        margin: 0;
        font-size: 1.05rem;
      }

      .forms-help {
        margin: 8px 0 12px;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .forms-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 10px;
      }

      .form-item {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px;
        background: #fcfcfc;
      }

      .form-item strong {
        display: block;
        margin-bottom: 4px;
      }

      .form-meta {
        color: var(--muted);
        font-size: 0.86rem;
      }
    </style>
  </head>
  <body>
    <main class="card">
      <h1>MongoDB Form Kaydi</h1>
      <p>Asagidaki formu gonderince veriler MongoDB icine kaydedilir.</p>

      <form id="contactForm">
        <label>
          Ad Soyad
          <input type="text" name="name" required />
        </label>

        <label>
          E-posta
          <input type="email" name="email" required />
        </label>

        <label>
          Mesaj
          <textarea name="message" required></textarea>
        </label>

        <button type="submit">Kaydet</button>
      </form>

      <div class="status" id="status"></div>

      <section class="forms">
        <div class="forms-header">
          <h2>Kayitli Formlar</h2>
          <button type="button" id="refreshButton">Yenile</button>
        </div>
        <p class="forms-help">Son 20 kayit gosterilir.</p>
        <div class="status" id="listStatus"></div>
        <ul class="forms-list" id="formsList"></ul>
      </section>
    </main>

    <script>
      const form = document.getElementById("contactForm");
      const statusElement = document.getElementById("status");
      const refreshButton = document.getElementById("refreshButton");
      const listStatusElement = document.getElementById("listStatus");
      const formsList = document.getElementById("formsList");

      function formatDate(value) {
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return "-";
        }
        return new Intl.DateTimeFormat("tr-TR", {
          dateStyle: "short",
          timeStyle: "short",
        }).format(date);
      }

      function renderForms(items) {
        formsList.innerHTML = "";

        if (!items.length) {
          const emptyItem = document.createElement("li");
          emptyItem.className = "form-item";
          emptyItem.textContent = "Henuz kayit yok.";
          formsList.appendChild(emptyItem);
          return;
        }

        items.forEach((item) => {
          const row = document.createElement("li");
          row.className = "form-item";

          const title = document.createElement("strong");
          title.textContent = item.name;

          const email = document.createElement("div");
          email.className = "form-meta";
          email.textContent = item.email;

          const message = document.createElement("p");
          message.textContent = item.message;

          const createdAt = document.createElement("div");
          createdAt.className = "form-meta";
          createdAt.textContent = `Tarih: ${formatDate(item.createdAt)}`;

          row.appendChild(title);
          row.appendChild(email);
          row.appendChild(message);
          row.appendChild(createdAt);

          formsList.appendChild(row);
        });
      }

      async function loadForms() {
        listStatusElement.className = "status";
        listStatusElement.textContent = "Kayitlar yukleniyor...";
        refreshButton.disabled = true;

        try {
          const response = await fetch("/api/forms?limit=20");
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "Formlar alinamadi.");
          }

          renderForms(data.items || []);
          listStatusElement.className = "status success";
          listStatusElement.textContent = `${data.count} kayit listelendi.`;
        } catch (error) {
          formsList.innerHTML = "";
          listStatusElement.className = "status error";
          listStatusElement.textContent = error.message;
        } finally {
          refreshButton.disabled = false;
        }
      }

      refreshButton.addEventListener("click", loadForms);

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusElement.className = "status";
        statusElement.textContent = "Gonderiliyor...";

        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        try {
          const response = await fetch("/api/forms", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "Kayit sirasinda hata olustu.");
          }

          form.reset();
          statusElement.className = "status success";
          statusElement.textContent = `${data.message} ID: ${data.id}`;
          await loadForms();
        } catch (error) {
          statusElement.className = "status error";
          statusElement.textContent = error.message;
        }
      });

      loadForms();
    </script>
  </body>
</html>
